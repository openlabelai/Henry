# 2026-02-28

## Upload System — Final Working State
- **Parallel upload + shared polling** — all files POST simultaneously, poll all jobIds in one loop
- Single rewrite rule: `/api/:path*` → `http://localhost:3001/api/:path*` (replaced 20+ individual rewrites)
- Clerk middleware only protects pages, `api/*` excluded from matcher entirely
- No API route proxy files in frontend — all deleted
- Cloudflare Tunnel `connectTimeout: 120s` (was default 30s)
- TZ=UTC on both systemd services (openlabel-backend, openlabel-frontend)
- Tested with agent-browser: 1, 2, 3, 4, and 12 files all ✅ through Cloudflare Tunnel
- **12 ADA reports in DB: 632,902 entries, $179,649.03** (Dec 2024 — Jan 2026)

## Shared Types Package (@openlabel/shared)
- `shared/` directory at repo root with: enums.ts, entry.ts, parser.ts, report.ts, catalog.ts, index.ts
- Backend `parser.ts` re-exports from shared (backward compat)
- Frontend `api.ts` imports all types from shared, re-exports for compat
- `SerializedRoyaltyEntry` (string dates) for frontend, `ParsedRoyaltyEntry` (Date objects) for backend
- `transpilePackages: ['@openlabel/shared']` in next.config.ts
- 296/296 parser tests pass, 0 TS errors

## Backup System
- Workspace backed up to `github.com/openlabelai/Henry` (private repo)
- Cron job `henry-backup-6h`: runs every 6h (0,6,12,18 UTC)
- Script at `/host/home/scripts/backup.sh` — redacts secrets before push
- Git config: user `Henry`, email `henry@openlabelai.com`

## Key Bugs Fixed Today
1. `deleteCatalogReport` → `deleteReport` (function name mismatch)
2. Batch endpoint 404 (Clerk middleware intercepting before rewrite)
3. Removed queue polling accidentally (upload showed "Failed" for successful queued jobs)
4. Sequential uploads timeout through Cloudflare (switched to parallel)
5. Cloudflare Tunnel default timeout too short (extended to 120s)
6. TZ=UTC missing on GB10 services (parser date tests failing)

## Lessons
- **Don't remove code you don't understand** — I removed polling thinking it was dead code, but Redis/BullMQ queue was active
- **Test through the actual deployment path** (Cloudflare Tunnel), not just localhost
- **One pattern for everything** — dual proxy patterns (rewrites + API routes) cause an entire class of bugs
- **Parallel > sequential for multi-file upload** — sequential blocks on each file, causing timeouts

## Security Audit (Late Night Session ~01:30-02:00 UTC)
- External audit from Codex — 7 findings, **3 real, 4 hallucinated** (Codex had old/wrong codebase)
- **Fixed: chat.ts IDOR** — X-Org-Id accepted without membership validation. Added `resolveOrgContext()`. Commit `d6f80ab`.
- **Fixed: TOCTOU race on member mutations** — `updateMember`/`removeMember` used findFirst + update in 2 steps. Now atomic `updateMany` with orgId guard. Commit `40436b1`.
- **Fixed: webhook raw body** — `express.json()` ran before webhook routes, breaking signature verification. Moved webhook mount before JSON parser. Commit `e952dcb`.
- Hallucinated findings: split percentage mismatch, split signing API, split notifications, auth tokens — none of these files/features exist in our codebase

## Org-Scoped Data Migration (~01:30-02:00 UTC)
- **Spec written**: `docs/TASK-ORG-MIGRATION.md` — full 4-phase plan
- **Linus built it** on `feature/org-migration` (spawned as sub-agent)
- **27 files changed** — all services + routes now use orgId instead of userId
- Schema: Report.userId → uploadedBy, Release.userId → createdBy, orgId added to Report + RoyaltyEntry
- **DB migration ran on GB10**: renamed columns, backfilled orgId for 632K entries, added indexes
- All routes now use `resolveOrgContext()` middleware
- `buildScopeFilter` ready for RBAC (ARTIST sees own tracks, PRODUCER sees splits)
- Merged to main: commit `1b65514`

## Post-Migration Frontend Fixes (~02:07-02:40 UTC)
- **Earnings page empty** — `fetchAPI` in `earnings.ts` wasn't sending X-Org-Id. Fixed.
- **Created OrgProvider component** — auto-fetches user's org on app load, sets `activeOrgId` in localStorage. Added to root layout.
- **Created `orgFetch()` wrapper** in `api.ts` — all API calls now inject `orgHeaders()` automatically
- **Analytics + HomePanel empty** — same missing header issue. Fixed `analytics.ts` fetchAPI and HomePanel fetch.
- **HomePanel race condition** — fetched before OrgProvider set activeOrgId. Added retry loop (waits up to 3s).
- **Root URL fix** — `/` now renders chat workspace directly (moved to `app/page.tsx` outside dashboard layout group) instead of redirecting to `/chat`
- **Analytics cache** — 5-min in-memory cache for overview endpoint. Invalidates on report delete. `backend/src/services/cache.ts`.

## Forensic Scan Results
- **240 findings** from 12 months of ADA data: 78 critical, 106 warning, 56 info
- Key finding: "Other US per-stream rate dropped 97% in Q2 2025" — $21,843 estimated impact
- Findings keyed by track name in `affectedTracks` arrays
- Inline forensic badges wired on earnings page (Song view only — `groupBy === 'song'`)
- Scan ID: `cmm5oiqnp000013wghxro3pl9`

## YC Application v4
- Drafted at `Obsidian/Henry/YC-APPLICATION-DRAFT-V4.md`
- Key changes from v3: "I" not "we", forensic angle ("$25K audit in $49/mo"), killed "pre-revenue and proud", added urgency, MLC free scan as acquisition hook, $1B path
- Tagline changed: "AI forensic auditor for music royalties"
- Seb hasn't reviewed yet

## State
- `main`: b86eb4f
- GB10: all services running, schema migrated, forensic scan complete
- Frontend: OrgProvider + orgFetch pattern — all API calls org-scoped
- Home panel shows at `/` (full-bleed, no redirect)
- 240 forensic findings in DB, inline badges ready on Song view
- **Every frontend fetch needs orgHeaders()** — org migration broke ALL API calls that weren't sending X-Org-Id. Created `orgFetch()` wrapper in api.ts, but individual components (IssuesDashboard, HomePanel, analytics, earnings) each had their own fetch calls that needed fixing individually.
- Issues finding status PATCH also needed orgHeaders fix (commit `dbf13af`)
- Seb went to bed ~03:00 UTC

## Tomorrow's Priorities
1. Seb reviews YC v4 draft
2. Verify inline forensic badges on Song view
3. Fix any remaining missing orgHeaders (grep for raw `fetch('/api` without orgHeaders)
4. Record demo video (upload → earnings → forensic badge → chat)
5. Record founder video (60s script in v4)
6. Get beta users / LOIs
7. Submit YC application
