# 2026-02-28

## Upload System — Final Working State
- **Parallel upload + shared polling** — all files POST simultaneously, poll all jobIds in one loop
- Single rewrite rule: `/api/:path*` → `http://localhost:3001/api/:path*` (replaced 20+ individual rewrites)
- Clerk middleware only protects pages, `api/*` excluded from matcher entirely
- No API route proxy files in frontend — all deleted
- Cloudflare Tunnel `connectTimeout: 120s` (was default 30s)
- TZ=UTC on both systemd services (openlabel-backend, openlabel-frontend)
- Tested with agent-browser: 1, 2, 3, 4, and 12 files all ✅ through Cloudflare Tunnel
- **12 ADA reports in DB: 632,902 entries, $179,649.03** (Dec 2024 — Jan 2026)

## Shared Types Package (@openlabel/shared)
- `shared/` directory at repo root with: enums.ts, entry.ts, parser.ts, report.ts, catalog.ts, index.ts
- Backend `parser.ts` re-exports from shared (backward compat)
- Frontend `api.ts` imports all types from shared, re-exports for compat
- `SerializedRoyaltyEntry` (string dates) for frontend, `ParsedRoyaltyEntry` (Date objects) for backend
- `transpilePackages: ['@openlabel/shared']` in next.config.ts
- 296/296 parser tests pass, 0 TS errors

## Backup System
- Workspace backed up to `github.com/openlabelai/Henry` (private repo)
- Cron job `henry-backup-6h`: runs every 6h (0,6,12,18 UTC)
- Script at `/host/home/scripts/backup.sh` — redacts secrets before push
- Git config: user `Henry`, email `henry@openlabelai.com`

## Key Bugs Fixed Today
1. `deleteCatalogReport` → `deleteReport` (function name mismatch)
2. Batch endpoint 404 (Clerk middleware intercepting before rewrite)
3. Removed queue polling accidentally (upload showed "Failed" for successful queued jobs)
4. Sequential uploads timeout through Cloudflare (switched to parallel)
5. Cloudflare Tunnel default timeout too short (extended to 120s)
6. TZ=UTC missing on GB10 services (parser date tests failing)

## Lessons
- **Don't remove code you don't understand** — I removed polling thinking it was dead code, but Redis/BullMQ queue was active
- **Test through the actual deployment path** (Cloudflare Tunnel), not just localhost
- **One pattern for everything** — dual proxy patterns (rewrites + API routes) cause an entire class of bugs
- **Parallel > sequential for multi-file upload** — sequential blocks on each file, causing timeouts

## State
- `main`: 25dc951
- GB10: all services running, TZ=UTC, Cloudflare Tunnel with 120s timeout
- Upload page: parallel upload + polling, delete working
- Next: forensic scan with 12 months of data, then YC application
