# 2026-02-27

## Done
- Reviewed Dex's entity resolution branch (8/10) â€” found @@unique bug on nullable ISRC/IPI, fixed + pushed
- Reviewed Linus's forensic single-source branch (7.5/10) â€” found duplicate PrismaClient import, userId/orgId assumption, stray file edit, fixed + pushed
- Merged both branches to main (resolved schema + index.ts conflicts)
- Upgraded Linus from Sonnet 4 â†’ Opus 4.6 (config synced to both locations)
- Deleted BOOTSTRAP.md (was triggering fresh-session intro messages)
- Updated all platform docs: AGENT-CONTEXT.md, VISION.md, README.md
- Updated MEMORY.md with entity resolution + forensic intelligence status
- Main now at commit ff22102 â€” 25 models, 797 tests, 60+ endpoints

## Spawned
- Jaques: UX research on how other platforms present forensic findings + entity resolution (catalog-integrated vs separate sections)

## Decisions
- Forensics + entity UI probably belongs integrated into catalog/earnings pages, not separate nav items
- Linus on Opus 4.6 now â€” should produce higher quality output
- Severity sort alphabetical asc actually works (critical < info < warning) â€” my initial review was wrong, corrected

## Done (continued â€” session 2)
- Jaques delivered excellent UX research: `OBSIDIAN/Jaques/FORENSIC-ENTITY-UX-RESEARCH.md` â€” hybrid model recommended (inline badges + dedicated Issues hub)
- Spawned Dex for forensic + entity frontend build â€” first frontend task for Codex 5.3
- Dex delivered 727 lines, 10 files. Review: 7/10. Found 6 bugs:
  - ðŸ”´ `estimatedImpactUsd` â†’ `estimatedImpact` (field name mismatch)
  - ðŸ”´ `artist` â†’ `artistName` (Prisma model field name)
  - ðŸ”´ `canonicalTrackId` â†’ `canonicalId` + missing `include: { canonical: true }` on backend
  - ðŸŸ¡ Hardcoded "Rate dropped 35%" badge text
  - ðŸŸ¡ Wrong `possibleDuplicate` logic (aliases > 1 is normal)
  - ðŸŸ¢ Unused `_data` variable
- Sent back to Dex â€” fixed all 6 on second pass, build passes. Merged to main.
- Found merge artifact: missing `}` for ArtistAlias in schema.prisma â€” fixed
- **Major fix: Clerk middleware was blocking ALL /api/* routes** â€” backend-proxied routes need to be public in Clerk middleware since backend handles its own auth. Added all routes to `isPublicRoute`.
- **Major fix: Missing API rewrites in next.config.ts** â€” `/api/forensics/*`, `/api/entities/*`, splits, releases, templates, calendar, contributors, org-settings, parsers were all 404ing. Added all 12 missing rewrites.
- Deployed app: backend on :3001, frontend on :3000 (Mac Mini Docker)
- Synology needed manual restart â€” Postgres/Redis containers don't auto-start
- Ollama cold start ~25s to load Qwen 3.5 into GPU, then fast

## Decisions (continued)
- Jaques research confirms: hybrid model is best â€” inline contextual badges + dedicated "Issues" nav section
- No music royalty platform has ANY anomaly UX â€” wide open competitive gap
- Dex is viable for frontend work â€” needs one review round for field name mismatches but delivers clean code
- Backend-proxied API routes should be public in Clerk middleware â€” backend validates auth itself
- Every new backend route MUST also be added to next.config.ts rewrites AND middleware.ts public routes

## Lessons Learned
- **Always check next.config.ts rewrites when adding new API routes** â€” Dex's frontend was calling APIs that weren't proxied (404)
- **Clerk middleware intercepts before rewrites** â€” must explicitly mark backend-proxied routes as public
- **Schema merge conflicts need careful review** â€” missing closing brace broke prisma entirely
- **Dex (Codex 5.3) on frontend**: delivers 7/10 first pass, 9/10 after review. Field name mismatches are his main weakness (doesn't have Prisma schema memorized). Good component architecture, correct patterns.
- **Ollama cold start**: first request after idle loads model (~25s). Keep-alive is 24h but Synology restart killed it.

## State
- `main`: 032efff
- All feature branches merged
- App running on Mac Mini Docker (:3000 frontend, :3001 backend)
- Synology: Postgres :5433 âœ…, Redis :6380 (needs verify)
- Ollama on GB10: warm, 24.5 tok/s
- Chat may still have auth issues from browser â€” Seb testing
- Gateway restarted by Seb (Linus on Opus 4.6)

## Session 3 â€” UI Audit & Fixes (~5:30-5:52 AM UTC)

### UI Audit Results
- **NavBar duplicate nav fixed** â€” removed hardcoded Upload/Analytics/Issues/Catalog links from `NavBar.tsx`; sidebar handles all navigation now
- **Catalog "Loading..." fix** â€” `loadEntities()` was throwing (missing X-Org-Id) and blocking entire `loadAll()` via `Promise.all`. Made entity loading non-fatal with try/catch.
- **Issues X-Org-Id fix** â€” `IssuesDashboard.tsx` fetch calls for scans, findings, entities all lacked `orgHeaders()`. Added `import('../../lib/orgContext')` to all fetch calls.
- **Catalog entity fetches** â€” same X-Org-Id fix applied to `/app/(dashboard)/catalog/page.tsx`
- **benchmarks.ts field fix** â€” `quantityâ†’streamCount`, `{not:null}â†’{not:''}` / `{gt:0}`, `_sum` fields updated. This was the persistent `benchmarks.ts:57` crash.
- **SSE auth fix for LAN** â€” `frontend/lib/chat.ts` now tries direct `:3001` first, falls back to Next.js proxy if auth fails. Needed because Clerk cookies don't cross ports from LAN browsers.

### Page Status After Fixes
- Chat: âœ… streaming + tool calls working (from localhost; LAN fallback deployed)
- Home: âœ…
- Earnings: âœ… data loading
- Analytics: ðŸŸ¡ chart works, KPIs still skeleton (pre-existing)
- Catalog: âœ… fixed â€” 64K entries, $24K revenue, 1 ADA report
- Upload: âœ…
- Issues: âœ… scan runs, 0 findings (correct for single-report data)

### Commits
- `158fe1f` â€” NavBar cleanup + X-Org-Id headers + catalog non-fatal entities
- `4771af9` â€” benchmarks.ts field mismatches
- `57d1e94` â€” SSE fallback to proxy for LAN auth

### Key Learnings
- **Dex doesn't use `orgHeaders()`** â€” every component Dex builds needs review for missing org context headers
- **`Promise.all` is dangerous for optional data** â€” one failure kills the whole page load. Always wrap optional fetches.
- **Clerk cookies are port-scoped** â€” direct backend calls from LAN browsers fail auth because cookies set on `:3000` aren't sent to `:3001`
- **Backend restart required after code changes** â€” was debugging "broken" chat that was actually running stale code (old benchmarks.ts)

## Session 4 (~4pm UTC)
- **Analytics KPI cards: root cause found** â€” Synology Postgres (`192.168.100.200:5433`) unreachable. All `/api/analytics/overview` calls return 500 â†’ KpiCards stuck on skeleton loading state.
- Not a frontend bug â€” backend `analyticsService.ts:126` throws `P1001` (can't reach DB)
- Redis was also reported down earlier (`ECONNREFUSED :6380`)
- **Synology containers may need restart** â€” Postgres + Redis

## Session 4 â€” Dev Environment Consolidation (~4-7:30pm UTC)
- **Consolidated entire stack onto GB10** â€” eliminated Synology + Mac Mini dependency
- Postgres 16 + Redis 7 in Docker (host networking, `unless-stopped`)
- Backend (tsx watch) + Frontend (Next.js) as systemd services
- Cloned repo to `~/openlabel/repo` on GB10, installed Node 22
- Backend `.env` points all services to localhost (DB, Redis, Ollama)
- **Cloudflare Tunnel live** â€” `app.openlabelai.com` â†’ GB10 localhost:3000
  - Tunnel ID: `502c2421-4392-4ce3-b8d8-23bfe78216b6`
  - Installed as systemd service, survives reboots
  - Config at `/etc/cloudflared/config.yml`
- **All services auto-restart on reboot**: cloudflared, postgres, redis, backend, frontend, ollama, ollama-warmup
- DB is empty (fresh schema push) â€” need to re-upload royalty reports
- Node_modules were Linux-ARM64 incompatible with macOS (esbuild binary mismatch) â€” reinstalled natively on each platform
- My container can reach GB10 via SSH (ethernet connection fixed by Seb)
- Mac Mini still has local Postgres+Redis running from earlier setup (can be cleaned up later)
- Landing page unaffected: `openlabelai.com` â†’ Vercel, `app.openlabelai.com` â†’ GB10

## Session 5 â€” Upload Fix & Cleanup (~10pm-midnight UTC)

### Upload Bugs Found & Fixed
1. **`deleteCatalogReport` doesn't exist** â€” was `deleteReport` in api.ts. Fixed name.
2. **Batch endpoint 404** â€” Next.js Clerk middleware intercepted `/api/upload/batch` before rewrite. Root cause: inconsistent dual-proxy pattern (some routes rewrites, some API route proxies).
3. **Refactored ALL routes to single rewrite** â€” `'/api/:path*' â†’ backend`. Deleted ALL API route proxy files. Simplified middleware to skip all `/api/*`. -193 lines, +9 lines.
4. **Shared types package** â€” Merged Linus's `@openlabel/shared` (cherry-picked, rebased onto cleanup). Single source of truth for types. 0 TS errors.
5. **Queue polling removed accidentally** â€” Upload returns `{accepted, jobId}` when Redis is available. My cleanup removed the polling code. Frontend showed "Failed" for successful uploads.
6. **Sequential uploads timeout through Cloudflare** â€” Later files in sequence would timeout waiting for earlier files. Fixed with parallel upload + shared polling loop.
7. **Cloudflare Tunnel timeout** â€” Default 30s too short. Extended `connectTimeout` to 120s.
8. **TZ=UTC on systemd services** â€” Parser tests were failing due to EST timezone on GB10.

### Architecture Decisions
- **One rewrite rule for all `/api/*`** â€” no more per-route config, middleware entries, or API proxy files
- **Parallel upload + shared polling** â€” all files POST simultaneously, then poll all jobIds in a loop
- **No batch endpoint needed** â€” sequential single uploads with queue is simpler and more reliable
- **`@openlabel/shared`** â€” types defined once, imported by both backend and frontend

### Testing
- Used `agent-browser` to test upload end-to-end through Cloudflare Tunnel
- Tested: 1 file âœ…, 2 files âœ…, 3 files âœ…, 4 files âœ…, 12 files âœ…
- Delete âœ…
- All 12 ADA reports: 632,902 entries, $179,649.03

### Backup
- Workspace backed up to `github.com/openlabelai/Henry`
- Cron job: every 6h auto-backup (secrets redacted)

### State
- `main`: 25dc951
- 12 reports in DB, 632K entries
- All services running on GB10 with TZ=UTC
