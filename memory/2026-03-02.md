# 2026-03-02

## R2 Presigned Upload Pipeline — SHIPPED ✅

### Problem
- `next start` buffers entire request body during rewrite proxy → uploads >10MB hang
- Cloudflare Tunnel has 100MB cap on free tier
- Clerk dev mode auth (`dev-browser-missing`) breaks on server-to-server forwarded requests
- Tried route handlers with streaming, Bearer token extraction, `afterFiles` rewrites — none solved all 3 issues

### Solution: Presigned URLs to Cloudflare R2
- Browser gets presigned PUT URL from backend (tiny JSON request through existing proxy)
- Browser PUTs file directly to R2 (bypasses Next.js AND Cloudflare Tunnel entirely)
- Backend downloads from R2 for processing, cleans up after
- XHR gives real upload progress events

### Implementation
- Jaques researched 6 approaches → recommended presigned R2 (industry standard)
- Linus built full pipeline on `feature/r2-upload` (6 commits)
- Henry reviewed: 3 fixes (health check probe, streaming download, fileKey validation)
- Merged to main: commit `f267bca`

### Files Added/Changed
- `backend/src/services/r2.ts` — S3Client, presign, streaming download, delete, CORS
- `backend/src/routes/upload.ts` — presign + complete routes (above existing multer routes)
- `backend/src/services/queue.ts` — R2 cleanup after processing
- `frontend/lib/r2Upload.ts` — presign → XHR PUT with progress → complete
- `frontend/lib/uploadStore.ts` — R2 when available, fallback to direct
- `shared/src/upload.ts` — PresignRequest, PresignResponse, UploadCompleteRequest
- `backend/src/__tests__/r2.test.ts` — 6 tests

### R2 Config
- Bucket: `openlabel-uploads`
- Account ID: `7b18647c39ee43362004a4357cce5e01`
- Env vars set in `backend/.env` on GB10
- CORS set programmatically via `ensureBucketCors()` on first presign

### Key Fixes During Deploy
- `unhoistableHeaders: new Set(['content-type'])` — don't sign ContentType in presigned URL (mismatch causes 403)
- CORS: `AllowedHeaders: ['*']`, methods `PUT/GET/HEAD`, expose `ETag`
- `afterFiles` rewrites so route handlers take priority (reverted — went with R2 instead)

### Reverted
- Removed `frontend/app/api/upload/route.ts` and `batch/route.ts` — route handler proxy approach abandoned
- Restored simple catch-all rewrite in `next.config.ts`

### Result
- 48MB file uploaded successfully through `next start` production mode
- Frontend shows real progress bar during upload
- Existing multer routes preserved as fallback (when R2 not configured)
- Speed limited by user's upstream bandwidth, not architecture

### Frontend Mode
- Switched back to `next start` (production) — was on `next dev` as temporary workaround
