# 2026-02-24 — Daily Log

## Clerk Auth + Next.js 16 Debugging (02:00–03:17 UTC)

### Problem
- Unauthenticated users could access `/analytics` without redirect to sign-in
- Next.js 16.1.6 deprecated `middleware.ts` for `proxy.ts` convention

### Key Findings
1. **Next.js 16 proxy.ts exports named `proxy` function** (not default export) — Clerk's `clerkMiddleware` returns default export, incompatible
2. **Clerk @clerk/nextjs@6.38.1 does NOT support Next.js 16 proxy.ts** — `auth.protect()` returns 404 instead of redirect
3. Even using `middleware.ts` (deprecated but still runs in v16), Clerk's internal detection fails: "auth() was called but Clerk can't detect usage of clerkMiddleware()"
4. Custom cookie-based auth check in proxy.ts works for redirects but breaks Clerk's `auth()` context in page components

### Decision
- **Pinned Next.js to 15.3.3** — Seb approved. Will upgrade when Clerk releases Next 16 support.
- Seb explicitly said: **no quick fixes ever** — take time to understand problems properly

### Route Conflict Found
- Duplicate sign-in/sign-up pages: `app/(dashboard)/sign-in/` AND `app/sign-in/` — caused 500 errors on ALL routes
- Removed the `(dashboard)` copies — committed to main

### Current State (as of 03:17 UTC)
- Backend running on Synology ✅ (health check passes)
- Frontend: restarting after cache clear, needs time to compile on Synology ARM
- Next.js 15.3.3 installed in container, middleware.ts with clerkMiddleware in place
- Still need to verify auth redirect works end-to-end after clean restart

### Commits
- `c29c3b4` — Pin Next.js to 15.3.3
- `47e68a1` — Remove duplicate sign-in/sign-up pages from (dashboard) route group

### Lesson
- Next.js 16 released Feb 20, 2026 — too new for Clerk. Don't adopt framework versions before auth providers support them.
- Container restarts on Synology wipe git/openssl — need `apt-get install` each time. Backend `dist/` persists via volume mount but needs `prisma generate` + `tsc` after restart.

## Auth & Frontend Fixes (02:15–03:47 UTC)

### What Got Fixed
1. **Clerk auth enforcement working** — middleware.ts with explicit `redirectToSignIn()` pattern on Next.js 15.3.3
2. **Duplicate sign-in/sign-up pages removed** — `app/(dashboard)/sign-in` conflicted with `app/sign-in`, caused 500 on all routes
3. **Default route → `/chat`** instead of `/analytics` — chat is the primary experience
4. **Duplicate header in iframe panels fixed** — NavBar client component hides itself when `?embed=1` query param present

### Seb Feedback
- "No quick fixes ever" — always understand the root cause
- Wanted the stable pre-auth version back (chat sidebar with nav)
- Confirmed auth login works, reported duplicate headers in embedded views

### Commits Pushed to main
- `c29c3b4` Pin Next.js to 15.3.3
- `47e68a1` Remove duplicate sign-in/sign-up pages
- `6ed8c26` Explicit redirectToSignIn() pattern
- `1e57b2d` Default route → /chat
- `55ea312` Hide nav bar in iframe embeds

### Architecture Notes
- Next.js 15.3.3 (not 16) — Clerk doesn't support Next 16 proxy.ts yet
- `middleware.ts` uses `auth().isAuthenticated` + `redirectToSignIn()` (not `auth.protect()` which returned 404)
- Public routes: /sign-in, /sign-up, /join, /onboarding, /api/webhooks
- IframePanel passes `?embed=1`, NavBar checks `useSearchParams()` and returns null when embedded
- Container restart procedure: `apt-get install git openssl` → `prisma generate` → `node dist/index.js` → `next dev -p 3000`

### Still TODO
- Onboarding flow (new users need to create or join an org)
- Org switcher integration end-to-end
- Migrate collab endpoints from URL params to X-Org-Id header
- Revenue verification branch review/merge
- Clerk webhook secret configuration

## Chromium + Puppeteer in Docker Container (~18:00 UTC)

### Setup
- Installed Chromium (`/usr/bin/chromium`) and `puppeteer-core` in `openlabel-app` container
- Container is x86_64 Debian 12 (bookworm), node:20-slim
- Launch flags: `--no-sandbox --disable-setuid-sandbox --disable-gpu`
- puppeteer-core installed at `/workspace/node_modules/puppeteer-core`

### Results
- Successfully took screenshot of analytics page (90KB PNG)
- Transferred via base64 (SCP not available on Synology)
- Auth redirect confirmed working — unauthenticated requests go to /sign-in
- Screenshot helper script written: `dev/openlabel/scripts/screenshot.js`

### Limitations
- Can't view screenshots in this chat (binary display only)
- Auth-protected pages redirect to sign-in — need Clerk test auth for proper visual testing
- Chromium installation doesn't survive container restarts (add to Dockerfile later)

### Transfer method
- Base64 encode in container → SSH cat → base64 decode on host

## Infrastructure Migration: Synology → Mac Mini (~18:10-18:50 UTC)

### Change
- App (frontend + backend) now runs locally on Mac Mini (192.168.100.238) instead of Synology
- Synology (192.168.100.200) only serves PostgreSQL (:5433) + Redis (:6380)
- Stopped `openlabel-app` container on Synology

### Setup
- Backend: `npx tsx src/index.ts` (runs from source, bypasses TSC errors)
- Frontend: `npx next dev -p 3000 -H 0.0.0.0`
- DB URL updated to point at `192.168.100.200:5433`
- Redis URL updated to `192.168.100.200:6380`
- Added `CLERK_SECRET_KEY` to frontend `.env.local`
- Ready in 1.7s (vs 30-45s on Synology!)

### TSC Fix (partial)
- Created `backend/src/types/express.d.ts` — declares `req.auth` as `SignedInAuthObject`
- Eliminated all `req.auth` type errors
- Remaining: ~105 errors (null checks, benchmarks schema mismatch)
- Workaround: `npx tsx` runs from source without needing `tsc` to compile

### Network Access
- Docker Desktop for Mac binds ports to localhost only, not LAN
- Fixed with Python port forwarder on Mac host (SSH → `openlabel@192.168.100.238`)
- SSH key added for Henry → Mac Mini access
- Mac Mini SSH user: `openlabel`, key-based auth

### HomePanel Hydration Fix
- Greeting (Good morning/afternoon/evening) caused SSR/client mismatch
- Fixed: moved to `useState` + `useEffect` (client-only), kept `now` in state for date display

## Marketing & Launch Campaign (~22:23-23:58 UTC)

### Suri Deliverables
1. `WAITLIST-CAMPAIGN-RESEARCH.md` — 10 case studies, tactics ranked by effort/impact
2. `LAUNCH-CAMPAIGN-PLAN.md` — 5-phase, 14-week campaign with full asset list, content calendar, Miami tactics
3. `PRICING-STRATEGY.md` — 8 pricing methods, recommended 4-tier structure ($29-$199/mo, founding rates $19-$149)
4. `SEBASJAY-SOCIAL-AUDIT.md` — initial audit had wrong account, corrected via SEBASJAY-CORRECTIONS.md
5. `LAUNCH-CAMPAIGN-PLAN-V2.md` — IN PROGRESS, updated for daily content production

### Seb's Social Stats (real)
- Instagram @sebasjay: 16,303 followers, 68% aged 25-44, Latin America heavy (Ecuador 19.2%, US 16%, Argentina 7.4%)
- TikTok @sebasjay: 6,192 followers, 72% male, dormant
- Combined: ~22,500

### Key Updates
- Seb hired a videographer/editor starting Feb 25 — daily content production
- Seb has extensive Miami music industry network (20 years, artists/writers/producers/executives)
- Plans to invite personal contacts for MVP test-drive
- Pricing: no free tier, 14-day trial, founding member locked rates

### Suri's Open Questions for Seb
- Founding Artist price point → addressed in PRICING-STRATEGY.md ($19/mo founding rate recommended)
- Miami network size → "extensive, 20 years, knows everybody"
- Social following → now documented with real stats

### Notion Content DB (~00:25-00:40 UTC, Feb 25)
- Connected to Seb's Notion: "SJE Content OS" database
- Token: `REDACTED_NOTION_TOKEN`
- Content DB ID: `247d2924-6f49-80fc-af56-e56b14c23137`
- Added properties: language, priority, campaign phase, brief, assigned to
- Updated options: status (+needs script, needs caption ES, scheduled), pillar (+product demo, industry pain point, testimonial), series (+openlabel launch), platforms (+linkedin, twitter)
- Populated Week 1: 10 entries (OL-001 through OL-008 + ES versions)
- Weeks 2-4 not yet populated

### Additional Updates
- Seb hired videographer/editor starting Feb 25
- Seb will create bilingual content (EN + ES) daily — "rewrite don't translate"
- Suri delivered: LAUNCH-CAMPAIGN-PLAN-V2.md (891 lines, compressed to 10-11 weeks), NOTION-CONTENT-DB.md, NOTION-CONTENT-ENTRIES.md (68 entries), VIDEOGRAPHER-BRIEF.md, PRICING-STRATEGY.md, SEBASJAY-CORRECTIONS.md
- **Dell GB10 shipped — arriving Feb 25!** Way earlier than expected (was ~March 2026)
- Setup plan: Llama 70B (chat), Qwen 7B (parser), pgvector/Qdrant (RAG)
